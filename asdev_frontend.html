<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASDev Launcher v10.26.37</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* TERMINAL FIRE THEME */
        body { background-color: #2a1005; color: #ffedd5; font-family: 'Comic Neue', cursive; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        #app-container { width: 100%; max-width: 1100px; background-color: #451a03; border: 6px solid #7c2d12; border-radius: 20px; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.95); position: relative; }
        .ticker-wrap { width: 100%; background-color: #2a1005; border-bottom: 2px solid #7c2d12; overflow: hidden; height: 40px; display: flex; align-items: center; position: relative; }
        .ticker { display: flex; gap: 2rem; white-space: nowrap; animation: marquee 80s linear infinite; /* Adjusted to 80s (50% slower than 40s) for smoother, visible scrolling */ font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #fb923c; }
        .ticker-item { display: inline-flex; align-items: center; gap: 6px; }
        .ticker-item a { color: #4ade80; text-decoration: underline; transition: color 0.2s; }
        .ticker-item a:hover { color: #ffffff; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .panel { background: rgba(20, 10, 5, 0.6); border: 2px solid #ea580c; border-radius: 12px; box-shadow: 6px 6px 0 #9a3412; padding: 32px; margin-bottom: 32px; }
        .input-field { background: #2a1005; border: 2px solid #7c2d12; color: #fb923c; font-family: 'JetBrains Mono', monospace; width: 100%; padding: 16px; margin-bottom: 20px; outline: none; transition: border-color 0.2s; border-radius: 6px; font-size: 16px; }
        .input-field:focus { border-color: #ea580c; }
        input[type="file"]::file-selector-button { background: #ea580c; border: none; color: #2a1005; padding: 10px 16px; font-family: 'JetBrains Mono'; font-weight: bold; cursor: pointer; margin-right: 15px; border-radius: 4px; }
        .btn-action { background: #ea580c; border: 2px solid #9a3412; color: #2a1005; font-weight: bold; font-family: 'JetBrains Mono'; text-transform: uppercase; width: 100%; padding: 20px; font-size: 20px; cursor: pointer; transition: all 0.1s; box-shadow: 5px 5px 0 #7c2d12; border-radius: 8px; }
        .btn-action:hover { background: #f97316; transform: translate(-1px, -1px); box-shadow: 6px 6px 0 #7c2d12; }
        .btn-action:active { transform: translate(2px, 2px); box-shadow: 0 0 0; }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); transform: none; box-shadow: none; }
        .status-box { background: rgba(0,0,0,0.3); border: 1px solid #ea580c; color: #fdba74; padding: 16px; font-size: 16px; font-family: 'JetBrains Mono'; text-align: center; margin-top: 20px; display: none; border-radius: 6px; }
        .status-success { border-color: #22c55e; color: #4ade80; background: rgba(20, 83, 45, 0.3); }
        .status-error { border-color: #ef4444; color: #fca5a5; background: rgba(127, 29, 29, 0.3); }
        .sys-status { color: #ef4444; font-weight: bold; transition: color 0.5s; cursor: pointer; }
        .sys-status.online { color: #22c55e; text-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
        #image-preview { width: 180px; height: 180px; border: 2px dashed #7c2d12; display: flex; align-items: center; justify-content: center; background: #2a1005; color: #7c2d12; font-family: 'JetBrains Mono'; font-size: 12px; overflow: hidden; border-radius: 12px; margin-top: 10px; cursor: pointer; position: relative; }
        #image-preview img { width: 100%; height: 100%; object-fit: cover; }
        /* DRAG AND DROP STATE */
        .drag-over { border-color: #22c55e !important; background-color: rgba(34, 197, 94, 0.2) !important; border-style: solid !important; transform: scale(1.02); }
        
        .log-entry { border-bottom: 1px solid rgba(234, 88, 12, 0.3); padding: 12px 0; font-family: 'JetBrains Mono'; font-size: 12px; display: flex; flex-direction: column; gap: 4px; }
        .log-entry:last-child { border-bottom: none; }
        .log-skipped { color: #fdba74; opacity: 0.8; }
        .log-success { color: #4ade80; font-weight: bold; }
        .log-error { color: #ef4444; }
        .toggle-switch { display: flex; align-items: center; }
        .toggle-switch input { display: none; }
        .toggle-switch .slider { cursor: pointer; width: 60px; height: 34px; background-color: #7c2d12; transition: .4s; border-radius: 34px; position: relative; box-shadow: inset 0 0 4px rgba(0,0,0,0.5); min-width: 60px; }
        .toggle-switch .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-switch input:checked + .slider { background-color: #ef4444; } 
        .toggle-switch input:checked + .slider:before { transform: translateX(26px); }
        .mayhem-label { transition: color 0.4s; }
        .mayhem-label.active { color: #ef4444; }
        /* FIX: Applied animation to a wrapper instead of the image */
        #logo-wrapper { 
            width: 60px; 
            height: 60px; 
            border-radius: 8px; 
            overflow: hidden; 
            min-width: 60px; /* Ensure fixed size for layout */
            animation: bounce 1s infinite alternate; 
        }
        #header-image { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            /* Removed animation: bounce 1s infinite alternate; */
        }
        @keyframes bounce { 
            from { transform: translateY(0); } 
            to { transform: translateY(-5px); } 
        }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #2a1005; margin: 5% auto; padding: 30px; border: 4px solid #ea580c; width: 85%; max-width: 800px; border-radius: 12px; box-shadow: 0 0 20px rgba(234, 88, 12, 0.5); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #fff; text-decoration: none; cursor: pointer; }
        .leader-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .leader-table th { text-align: left; padding: 10px; border-bottom: 2px solid #ea580c; color: #ea580c; text-transform: uppercase; font-size: 11px; }
        .leader-table td { padding: 12px 10px; border-bottom: 1px solid rgba(234, 88, 12, 0.2); vertical-align: middle; }
        .leader-table tr:hover { background: rgba(234, 88, 12, 0.1); }
        .token-img-sm { width: 32px; height: 32px; border-radius: 4px; object-fit: cover; display: inline-block; vertical-align: middle; margin-right: 8px; border: 1px solid #7c2d12; background-color: #2a1005; min-width: 32px; min-height: 32px; }
        .metric-card { background: rgba(0,0,0,0.2); border: 1px solid #ea580c; padding: 20px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: white; font-family: 'JetBrains Mono'; margin-top: 5px; }
        .metric-label { font-size: 12px; color: #fdba74; text-transform: uppercase; letter-spacing: 1px; }
        .holder-check { color: #4ade80; font-weight: bold; margin-left: 8px; display: inline-flex; align-items: center; gap: 2px; font-size: 10px; background: rgba(34, 197, 94, 0.2); padding: 2px 4px; border-radius: 4px; border: 1px solid #22c55e; }
        .badge-creator { color: #60a5fa; font-weight: bold; margin-left: 8px; display: inline-flex; align-items: center; gap: 2px; font-size: 10px; background: rgba(59, 130, 246, 0.2); padding: 2px 4px; border-radius: 4px; border: 1px solid #3b82f6; }
        .badge-bonded { display: inline-block; background-color: #22c55e; color: #000; font-weight: bold; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 6px; border: 1px solid #14532d; vertical-align: middle; }
        .badge-bonding { display: inline-block; background-color: #eab308; color: #000; font-weight: bold; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 6px; border: 1px solid #713f12; vertical-align: middle; }
        .tx-link { color: #a78bfa; text-decoration: underline; font-size: 10px; }
        .ca-display { word-break: break-all; user-select: all; cursor: copy; }
        /* Log Grid Styles */
        .log-grid { display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 11px; }
        .log-label { color: #fdba74; font-weight: bold; text-transform: uppercase; }
        .log-value { color: #ffedd5; word-break: break-all; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .badge-skipped { background: rgba(234, 88, 12, 0.2); color: #fb923c; border: 1px solid #ea580c; }
        .badge-success { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid #22c55e; }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(255, 255, 255, 0.1); }
        .status-item:last-child { border-bottom: none; }
        .status-icon { margin-right: 10px; }
        .text-green { color: #4ade80; }
        .text-red { color: #ef4444; }
        /* Wallet Modal Buttons */
        .btn-wallet {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2a1005;
            border: 1px solid #7c2d12;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: #fb923c;
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-wallet:hover {
            background: #451a03;
            border-color: #ea580c;
            transform: translateX(5px);
        }
        .btn-wallet .detected-tag {
            font-size: 10px;
            background: #22c55e;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div class="ticker-wrap"><div class="ticker" id="ticker-content"><span class="ticker-item text-orange-600">CONNECTING TO LAUNCH FEED...</span></div></div>

    <div class="p-10">
        <div class="flex justify-between items-start mb-10 border-b-4 border-orange-900 pb-8">
            <div class="flex items-center gap-6">
                <!-- WRAPPED THE IMAGE FOR STABLE BOUNCING -->
                <div id="logo-wrapper">
                    <img id="header-image" src="https://placehold.co/60x60/d97706/ffffff?text=LOGO" alt="Project Logo">
                </div>
                <div><h1 class="text-4xl md:text-5xl font-bold text-white tracking-wide leading-tight">IGNITION</h1><p class="text-orange-400 text-sm font-mono uppercase tracking-widest mt-2">ASDev Airdrop and Flywheel Pumpfun Launcher</p></div>
            </div>
            <div class="flex flex-col items-end gap-3">
                <div id="wallet-ui" class="hidden flex items-center gap-3 bg-orange-950 border border-orange-800 p-3 rounded-lg shadow-xl"><span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span><span id="wallet-addr" class="font-mono text-sm text-orange-200"></span><span id="wallet-bal" class="font-mono text-sm text-white font-bold ml-2 bg-orange-900/50 px-3 py-1 rounded">0.00 SOL</span><button id="refresh-btn" class="ml-2 text-orange-400 hover:text-white transition p-1.5 hover:bg-orange-800 rounded"><i data-lucide="refresh-cw" width="16"></i></button><button id="disconnect-btn" class="ml-1 text-red-400 hover:text-red-200 transition p-1.5 hover:bg-red-900/30 rounded"><i data-lucide="log-out" width="16"></i></button></div>
                <button id="connect-btn" onclick="openWalletModal()" class="bg-orange-900/50 border-2 border-orange-700 text-orange-500 px-8 py-3 rounded-lg font-mono text-sm hover:bg-orange-900/80 transition uppercase tracking-wider font-bold shadow-lg hover:shadow-orange-900/40">Connect Wallet</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="panel col-span-1 flex flex-col items-center justify-start h-full">
                <h3 class="text-orange-500 font-mono text-sm mb-6 uppercase tracking-widest w-full text-center border-b-2 border-orange-900/50 pb-3">Token Preview</h3>
                <div class="text-center mb-4 min-h-[60px]"><h2 id="preview-name" class="text-2xl font-bold text-white break-words">Token Name</h2><p id="preview-ticker" class="text-orange-400 font-mono text-lg uppercase">$TICKER</p></div>
                
                <!-- DRAG AND DROP ZONE -->
                <div id="image-preview" class="mb-6 shadow-2xl shadow-orange-900/30 transition-all duration-300" onclick="document.getElementById('image-file').click()">
                    <div class="text-center pointer-events-none">
                        <div class="text-2xl mb-2">üìÅ</div>
                        <div class="text-xs font-bold text-orange-400">DRAG & DROP<br>OR CLICK TO UPLOAD</div>
                    </div>
                </div>
                
                <input type="file" id="image-file" class="hidden" accept="image/png, image/jpeg, image/gif" onchange="previewImage(event)">
                <p class="text-xs text-orange-400 font-mono text-center mt-2">Required: PNG, JPG, GIF.<br>Max size 4MB.</p>
            </div>
            <div class="panel col-span-2">
                <h3 class="text-orange-500 font-mono text-sm mb-6 uppercase tracking-widest border-b-2 border-orange-900/50 pb-3">Token Metadata</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm text-orange-300 font-mono mb-2">NAME <span class="text-red-500">*</span></label><input type="text" id="name" class="input-field" placeholder="e.g. Infernal Coin" maxlength="32" oninput="updatePreview()"></div>
                    <div><label class="block text-sm text-orange-300 font-mono mb-2">TICKER <span class="text-red-500">*</span></label><input type="text" id="ticker" class="input-field" placeholder="e.g. BURN (Max 11 Chars)" maxlength="11" oninput="updatePreview()"></div>
                </div>
                <label class="block text-sm text-orange-300 font-mono mb-2">DESCRIPTION (Max 75 Chars)</label><textarea id="desc" class="input-field h-32" placeholder="Description of the asset (Max 75 chars)..." maxlength="75"></textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm text-orange-300 font-mono mb-2">TWITTER (OPTIONAL)</label><input type="url" id="twitter" class="input-field" placeholder="https://x.com/username"></div>
                    <div><label class="block text-sm text-orange-300 font-mono mb-2">WEBSITE (OPTIONAL)</label><input type="url" id="website" class="input-field" placeholder="https://project.io"></div>
                </div>
            </div>
        </div>

        <div class="panel bg-gradient-to-r from-orange-950 to-[#2a1005] border-2 border-orange-800 mt-10 lg:col-span-3"> 
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-orange-900 pb-4">
                <div class="flex justify-center items-center gap-4 w-full md:w-1/3 order-2 md:order-1 mb-4 md:mb-0">
                    <span class="mayhem-label text-orange-400 text-xs tracking-widest transition-colors duration-300" id="mayhem-status-label">MAYHEM MODE: OFF</span>
                    <label class="toggle-switch"><input type="checkbox" id="mayhem-toggle"><span class="slider"></span></label>
                </div>
                <div class="flex flex-col items-center w-full md:w-1/3 order-1 md:order-2">
                    <span class="text-orange-400 text-xs tracking-widest mb-1">DEPLOYMENT FEE</span>
                    <span class="text-white font-bold text-2xl">0.02 SOL</span>
                </div>
                <div class="w-full md:w-1/3 order-3"><button id="deploy-btn" class="btn-action w-full hover:scale-[1.01] active:scale-[0.99] transition-transform py-3 text-lg">INITIATE LAUNCH SEQUENCE</button></div>
            </div>
            <div class="text-center text-sm text-orange-400 mb-4 pt-2"><span class="font-bold">Mayhem Mode:</span> <span class="text-xs">(Enables Pump.fun's advanced features. Use with caution. Default is Standard Deployment.)</span></div>
            <div id="status-msg" class="status-box"></div>
        </div>
        
        <div class="panel bg-black/30 border border-orange-900 mt-8 lg:col-span-3">
            <div class="flex justify-between items-center border-b border-orange-900/50 pb-2 mb-4">
                <div class="flex items-center gap-4">
                    <h3 class="text-orange-500 font-mono text-sm uppercase tracking-widest">üî• TOP 10 LAUNCHES (BY 24H VOL)</h3>
                    <span id="leaderboard-last-updated" class="text-orange-600 text-xs font-mono">Syncing...</span>
                </div>
                <!-- UPDATED: Added Expand button -->
                <div class="flex items-center gap-2">
                    <button onclick="toggleAllLaunchesModal()" class="text-orange-400 hover:text-white transition p-1 rounded hover:bg-orange-800" title="Expand to All Launches">
                        <i data-lucide="maximize-2" width="16"></i>
                    </button>
                    <button onclick="updateLeaderboard()" class="text-orange-400 hover:text-white transition p-1 rounded hover:bg-orange-800" title="Refresh Leaderboard">
                        <i data-lucide="refresh-cw" width="16"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="leader-table">
                    <!-- REMOVED NAME COLUMN -->
                    <thead><tr><th style="width: 50px;">#</th><th>Token</th><th class="text-right">MCAP</th><th class="text-right">Vol (24H)</th><th class="text-right">Action</th></tr></thead>
                    <tbody id="leaderboard-body"><tr><td colspan="5" class="text-center text-orange-400 py-4">Scanning Chain Data...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- New Airdrop Panel -->
        <div class="panel bg-purple-950/30 border border-purple-800 mt-8 lg:col-span-3">
            <div class="flex justify-between items-center border-b border-purple-800/50 pb-2 mb-4">
                <h3 class="text-purple-400 font-mono text-sm uppercase tracking-widest">ü™Ç AIRDROP RESERVES & POINTS</h3>
                <!-- UPDATED: Added Expand Users button next to View History -->
                <div class="flex items-center gap-4">
                    <button onclick="toggleAllEligibleUsersModal()" class="text-purple-400 hover:text-white transition font-mono text-xs underline p-1">EXPAND USERS</button>
                    <button onclick="toggleAirdropLogModal()" class="text-purple-400 hover:text-white transition font-mono text-xs underline p-1">VIEW HISTORY</button>
                </div>
            </div>
            <div class="flex flex-col md:flex-row items-stretch justify-between gap-6 px-4">
                <!-- Holdings -->
                <div class="text-center w-full md:w-1/4 border-r border-purple-800/30 pr-4">
                    <div class="text-xs text-purple-300 uppercase mb-2 tracking-widest">Dev Wallet Holdings</div>
                    <!-- REMOVED: airdrop-value-sol div -->
                    <div class="text-3xl md:text-4xl text-purple-200 font-bold font-mono drop-shadow-[0_0_10px_rgba(168,85,247,0.5)]" id="airdrop-balance">0.00 <span class="text-lg align-top text-purple-400">$PUMP</span></div>
                </div>
                
                <!-- Status -->
                <div class="text-center w-full md:w-1/4 flex flex-col justify-center gap-3 border-r border-purple-800/30 pr-4">
                    <div class="flex justify-between items-center px-4">
                        <span class="text-[10px] text-purple-300 uppercase tracking-widest">Top Holder Pts</span>
                        <span class="text-lg text-yellow-400 font-bold font-mono" id="user-top-positions">0</span>
                    </div>
                    <!-- NEW: Creator Positions -->
                    <div class="flex justify-between items-center px-4">
                        <span class="text-[10px] text-blue-300 uppercase tracking-widest">Top Creator Pts</span>
                        <span class="text-lg text-blue-400 font-bold font-mono" id="user-created-positions">0</span>
                    </div>
                    <div class="flex justify-between items-center px-4">
                        <span class="text-[10px] text-purple-300 uppercase tracking-widest">ASDF Top 50</span>
                        <span id="asdf-status" class="text-sm font-bold font-mono text-gray-500">CHECKING...</span>
                    </div>
                </div>

                <!-- Points -->
                <div class="text-center w-full md:w-1/4 flex flex-col justify-center items-center border-r border-purple-800/30 pr-4">
                    <div class="flex justify-center items-center gap-2 mb-1">
                        <div class="text-xs text-purple-300 uppercase tracking-widest">Total Points</div>
                        <!-- NEW: Info button for disclaimer -->
                        <button onclick="toggleAirdropInfoModal()" class="p-0 text-purple-400 hover:text-white transition" title="View Update Information">
                            <i data-lucide="info" width="14" height="14"></i>
                        </button>
                    </div>
                    <div class="text-5xl text-white font-bold font-mono drop-shadow-[0_0_15px_rgba(234,179,8,0.6)]" id="user-total-points">0</div>
                    <div id="points-multiplier-badge" class="hidden mt-1 px-2 py-0.5 bg-green-500/20 border border-green-500 rounded text-[10px] text-green-400 font-bold tracking-wider">2X MULTIPLIER ACTIVE</div>
                </div>

                <!-- Expected -->
                <div class="text-center w-full md:w-1/4 flex flex-col justify-center items-center bg-purple-900/20 rounded-lg py-2">
                    <div class="text-[10px] text-purple-300 uppercase mb-1 tracking-widest">Expected Airdrop</div>
                    <div class="text-2xl text-green-400 font-bold font-mono" id="expected-airdrop">0.00</div>
                    <div class="text-[10px] text-purple-400 font-mono mt-1">$PUMP (Est)</div>
                </div>
            </div>
        </div>

        <div class="panel bg-orange-950/30 border border-orange-900 mt-8 lg:col-span-3">
            <div class="flex justify-between items-center border-b border-orange-900/50 pb-2 mb-4">
                <h3 class="text-orange-500 font-mono text-sm uppercase tracking-widest">BUYBACK & FEE TRACKER</h3>
                <button onclick="toggleLogModal()" class="text-orange-400 hover:text-white transition font-mono text-xs underline p-1">VIEW EXPANDED LOGS</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-black/30 p-4 rounded border border-orange-900/50">
                    <div class="text-xs text-orange-400 uppercase">Current Fee Balance</div>
                    <div class="text-xl text-white font-bold font-mono mt-1"><span id="track-balance">0.0000</span> SOL</div>
                </div>
                <div class="bg-black/30 p-4 rounded border border-orange-900/50">
                    <div class="text-xs text-orange-400 uppercase">Last Claim Amount</div>
                    <div class="text-xl text-green-400 font-bold font-mono mt-1"><span id="track-last-amt">0.0000</span> SOL</div>
                </div>
                <div class="bg-black/30 p-4 rounded border border-orange-900/50">
                    <div class="text-xs text-orange-400 uppercase">Last Claim Time</div>
                    <div class="text-sm text-white font-mono mt-2" id="track-last-time">Never</div>
                </div>
                <div class="bg-black/30 p-4 rounded border border-orange-900/50">
                    <div class="text-xs text-orange-400 uppercase">Next Check In</div>
                    <div class="text-xl text-yellow-400 font-bold font-mono mt-1" id="track-next-check">--:--</div>
                </div>
            </div>
        </div>

        <div class="panel bg-orange-900/10 mt-8 lg:col-span-3">
            <h3 class="text-orange-500 font-mono text-sm uppercase tracking-widest border-b border-orange-900/50 pb-2 mb-6">PLATFORM METRICS</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="metric-card"><div class="metric-label">Lifetime Launches</div><div id="metric-launches" class="metric-value">0</div></div>
                <div class="metric-card"><div class="metric-label">Total $PUMP Airdropped</div><div id="metric-pump" class="metric-value">0</div></div>
                <!-- CHANGED LABEL -->
                <div class="metric-card"><div class="metric-label">Total Daily Volume</div><div id="metric-fees" class="metric-value">$0.00</div></div>
            </div>
            <div class="text-center mt-6">
                <button onclick="toggleAboutModal()" class="text-orange-400 hover:text-white font-mono text-xs border border-orange-700 hover:bg-orange-800 px-4 py-2 rounded transition">‚ÑπÔ∏è VIEW FEE & BUYBACK MECHANICS</button>
            </div>
        </div>
        
        <div class="flex justify-between items-center mt-10 text-xs font-mono border-t border-orange-900 pt-6 opacity-70">
            <div><span class="text-orange-600">RPC UPLINK: MAINNET PUBLIC</span></div>
            <!-- MADE STATUS INDICATOR CLICKABLE -->
            <div class="flex gap-4"><span>SYSTEM STATUS: <span id="sys-status" class="sys-status" onclick="toggleStatusModal()">OFFLINE</span></span><span id="version-display" class="text-orange-500 font-bold">v...</span></div>
        </div>
    </div>
</div>

<!-- WALLET SELECTION MODAL -->
<div id="wallet-modal" class="modal">
    <div class="modal-content border-orange-600" style="max-width: 450px;">
        <span class="close-btn" onclick="closeWalletModal()">&times;</span>
        <h3 class="text-orange-500 font-mono text-lg mb-6 uppercase tracking-widest border-b border-orange-900/50 pb-2">SELECT WALLET PROVIDER</h3>
        <div id="wallet-list" class="flex flex-col gap-2">
            <button onclick="selectWallet('phantom')" class="btn-wallet" id="btn-phantom">
                <span class="flex items-center gap-3"><i data-lucide="ghost" width="20"></i> Phantom</span>
                <span id="tag-phantom" class="hidden detected-tag">DETECTED</span>
            </button>

            <button onclick="selectWallet('solflare')" class="btn-wallet" id="btn-solflare">
                <span class="flex items-center gap-3"><i data-lucide="flame" width="20"></i> Solflare</span>
                <span id="tag-solflare" class="hidden detected-tag">DETECTED</span>
            </button>

            <button onclick="selectWallet('backpack')" class="btn-wallet" id="btn-backpack">
                <span class="flex items-center gap-3"><i data-lucide="backpack" width="20"></i> Backpack</span>
                <span id="tag-backpack" class="hidden detected-tag">DETECTED</span>
            </button>
        </div>

        <p class="text-center text-xs text-orange-400/60 mt-4 font-mono">
            Selecting a wallet will prompt a connection request.
        </p>
    </div>
</div>

<div id="log-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeLogModal()">&times;</span>
        <h3 class="text-orange-500 font-mono text-lg mb-4 uppercase tracking-widest border-b border-orange-900/50 pb-2">FLYWHEEL & BUYBACK LOGS</h3>
        <div id="modal-log-content" class="max-h-[60vh] overflow-y-auto pr-2 flex flex-col gap-2"></div>
    </div>
</div>

<!-- HOLDERS MODAL -->
<div id="holders-modal" class="modal">
    <div class="modal-content border-orange-600" style="max-width: 400px;">
        <span class="close-btn" onclick="closeHoldersModal()">&times;</span>
        <h3 id="holders-modal-title" class="text-orange-500 font-mono text-lg mb-4 uppercase tracking-widest border-b border-orange-900/50 pb-2">Top Holders</h3>
        <div id="holders-list" class="max-h-[60vh] overflow-y-auto pr-2 font-mono text-xs">
            <!-- List injected here -->
        </div>
    </div>
</div>

<!-- NEW: SYSTEM STATUS MODAL -->
<div id="status-modal" class="modal">
    <div class="modal-content border-yellow-600" style="max-width: 450px;">
        <span class="close-btn" onclick="closeStatusModal()">&times;</span>
        <h3 class="text-yellow-400 font-mono text-lg mb-4 uppercase tracking-widest border-b border-yellow-800/50 pb-2">SYSTEM STATUS DIAGNOSTICS</h3>
        <div id="status-details-list" class="font-mono text-sm space-y-2">
            <!-- Status items injected here -->
        </div>
        <p class="text-xs text-yellow-500 mt-4">If services are offline, automatic processes (like airdrops and buybacks) may be delayed or halted.</p>
    </div>
</div>

<!-- NEW ALL LAUNCHES MODAL -->
<div id="all-launches-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeAllLaunchesModal()">&times;</span><h3 class="text-orange-500 font-mono text-lg mb-4 uppercase tracking-widest border-b border-orange-900/50 pb-2">ALL PLATFORM LAUNCHES</h3><div id="modal-all-launches-content" class="max-h-[70vh] overflow-y-auto pr-2">Loading...</div></div></div>

<!-- NEW ALL ELIGIBLE USERS MODAL -->
<div id="all-eligible-users-modal" class="modal"><div class="modal-content border-purple-600"><span class="close-btn" onclick="closeAllEligibleUsersModal()">&times;</span><h3 class="text-purple-400 font-mono text-lg mb-4 uppercase tracking-widest border-b border-purple-800/50 pb-2">ELIGIBLE AIRDROP USERS & POINTS</h3><div id="modal-all-eligible-users-content" class="max-h-[70vh] overflow-y-auto pr-2">Loading...</div></div></div>

<!-- NEW AIRDROP LOG MODAL -->
<div id="airdrop-log-modal" class="modal"><div class="modal-content border-purple-600"><span class="close-btn" onclick="closeAirdropLogModal()">&times;</span><h3 class="text-purple-400 font-mono text-lg mb-4 uppercase tracking-widest border-b border-purple-800/50 pb-2">AIRDROP DISTRIBUTION HISTORY</h3><div id="modal-airdrop-log-content" class="max-h-[60vh] overflow-y-auto pr-2">Loading...</div></div></div>

<!-- NEW AIRDROP INFO MODAL (DISCLAIMER) -->
<div id="airdrop-info-modal" class="modal">
    <div class="modal-content border-purple-600">
        <span class="close-btn" onclick="closeAirdropInfoModal()">&times;</span>
        <h3 class="text-purple-400 font-mono text-lg mb-4 uppercase tracking-widest border-b border-purple-800/50 pb-2">AIRDROP POINT CALCULATION NOTES</h3>
        <div class="font-sans text-sm text-purple-200 space-y-3">
            <p>The **Total Points** and **Expected Airdrop** metrics shown are subject to the platform's background update cycles.</p>
            <ul class="list-disc list-inside ml-4 space-y-1 text-purple-300">
                <li><span class="text-white">Base Points:</span> +1 for every Top 10 Leaderboard Token where you are a **Top 50 Holder**.</li>
                <li><span class="text-white">Creator Bonus:</span> <span class="text-blue-400 font-bold">+2 Points</span> for every Top 10 Leaderboard Token you **Created**.</li>
                <li><span class="text-white">Multiplier:</span> <span class="text-green-400 font-bold">2x Total Points</span> if you are a Top 50 Holder of **$ASDF**.</li>
                <li class="mt-2"><span class="text-yellow-400">Formula:</span> (Holdings + (Created * 2)) * Multiplier</li>
            </ul>
            <p class="text-yellow-400 font-bold mt-2 text-xs">Please rely on the blockchain for real-time holder data; the dashboard displays cached data for performance.</p>
        </div>
    </div>
</div>

<div id="about-modal" class="modal"><div class="modal-content"><span class="close-btn" onclick="closeAboutModal()">&times;</span><h3 class="text-orange-500 font-mono text-lg mb-4 uppercase tracking-widest border-b border-orange-900/50 pb-2">FEE & BUYBACK MECHANICS</h3>
    <div id="about-content-static">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 font-sans text-sm">
            <div>
                <h4 class="text-orange-400 font-bold mb-3 border-b border-orange-800 pb-1">1. REVENUE GENERATION</h4>
                <p class="text-orange-200 mb-2">The platform generates revenue through two primary streams:</p>
                <ul class="list-disc list-inside text-gray-400 space-y-1 mb-4">
                    <li><span class="text-white font-bold">Deployment Fee:</span> 0.02 SOL per token launch.</li>
                    <li><span class="text-white font-bold">Trading Rewards:</span> 1% of the bonding curve volume (Creator Fee).</li>
                </ul>

                <h4 class="text-orange-400 font-bold mb-3 border-b border-orange-800 pb-1">2. THE FLYWHEEL (BUYBACKS)</h4>
                <!-- UPDATED: Fee threshold changed from 0.20 SOL to 0.01 SOL -->
                <p class="text-orange-200 mb-2">Every 5 minutes, if the Fee Pool > 0.01 SOL:</p>
                <ul class="list-disc list-inside text-gray-400 space-y-1 mb-4">
                    <li><span class="text-green-400 font-bold">90.0%</span>: Buys **$PUMP** (Sent to Dev Wallet).</li>
                    <li><span class="text-red-400 font-bold">9.5%</span>: Sent to Fee Wallet ($ASDF Burns).</li>
                    <li><span class="text-red-400 font-bold">0.5%</span>: Sent to Upkeep.</li>
                </ul>
            </div>
            
            <div>
                <h4 class="text-purple-400 font-bold mb-3 border-b border-purple-800 pb-1">3. POINTS SYSTEM (QUALIFICATION)</h4>
                <p class="text-purple-200 mb-2">Users earn points by holding top tokens. No signup required.</p>
                <ul class="list-disc list-inside text-gray-400 space-y-1 mb-4">
                    <!-- Updated text to reflect Top 50 rule and CREATOR BONUS -->
                    <li><span class="text-white">Base Points:</span> +1 for every Top 10 Leaderboard Token where you are a **Top 50 Holder**.</li>
                    <li><span class="text-white">Creator Bonus:</span> <span class="text-blue-400 font-bold">+2 Points</span> for every Top 10 Leaderboard Token you **Created**.</li>
                    <li><span class="text-white">Multiplier:</span> <span class="text-green-400 font-bold">2x Total Points</span> if you are a Top 50 Holder of **$ASDF**.</li>
                </ul>
                <div class="bg-purple-900/30 p-3 rounded border border-purple-700/50">
                    <p class="text-[10px] text-purple-300 uppercase tracking-widest mb-1">MATH EXAMPLE</p>
                    <p class="text-xs text-gray-300">User is Top 50 in 3 coins (3pts).<br>User Created 1 Top 10 coin (2pts).<br>Base = 5.<br>User holds $ASDF (Top 50).<br><span class="text-white font-bold">Total Points = 5 x 2 = 10 Points.</span></p>
                </div>
            </div>
        </div>

        <div class="mt-6">
            <h4 class="text-green-400 font-bold mb-3 border-b border-green-800 pb-1">4. AUTOMATED AIRDROP ENGINE</h4>
            <p class="text-gray-300 mb-2">Runs automatically after the Flywheel check.</p>
            <ul class="list-disc list-inside text-gray-400 space-y-1">
                <li><span class="text-white font-bold">Trigger:</span> When Dev Wallet holds > 50,000 $PUMP and >0.25SOL.</li>
                <li><span class="text-white font-bold">Action:</span> Distributes **99%** of the $PUMP balance to all qualified users.</li>
                <li><span class="text-white font-bold">Distribution:</span> Proportional based on your share of the Total Global Points.</li>
            </ul>
        </div>

        <div class="mt-6 p-4 border border-orange-800 bg-orange-950/50 rounded-lg">
            <h5 class="text-red-400 font-bold mb-2 text-xs">LEGAL DISCLAIMER</h5>
            <p class="text-[10px] text-orange-300">This platform is a decentralized utility tool provided "as-is". The operators are not responsible for the nature of tokens created, their value, or any financial losses incurred. By using this service, you agree to comply with all applicable laws and regulations in your jurisdiction. Uploading illegal or prohibited content is strictly forbidden. Transactions on the blockchain are irreversible.</p>
        </div>
    </div>
</div></div>

<!-- Success Modal -->
<div id="success-modal" class="modal" style="display: none;">
    <div class="modal-content text-center border-green-600 bg-green-950/90 relative">
        <span class="close-btn absolute top-2 right-4 text-green-400 hover:text-white" onclick="closeSuccessModal()">&times;</span>
        <div class="mb-6"><i data-lucide="rocket" class="w-16 h-16 text-green-400 mx-auto animate-bounce"></i></div>
        <h3 class="text-green-400 font-bold font-mono mb-2 text-3xl tracking-widest">DEPLOYMENT SUCCESSFUL</h3>
        <p class="text-green-200 text-sm mb-6">Your token is live on the Solana blockchain!</p>
        
        <div class="bg-black/40 p-4 rounded-lg border border-green-800 mb-4 text-left">
            <p class="text-xs text-green-500 font-mono uppercase tracking-wider mb-1">CONTRACT ADDRESS (CA)</p>
            <p id="modal-mint-addr" class="text-white font-mono text-lg break-all font-bold ca-display" onclick="copyCA()"></p>
        </div>
        
        <div class="flex flex-col gap-3">
            <a id="modal-pump-link" href="#" target="_blank" class="block w-full text-center text-base font-mono text-black bg-yellow-400 hover:bg-yellow-300 py-3 rounded-lg font-bold transition shadow-lg hover:shadow-yellow-500/20">
                TRADE ON PUMP.FUN
            </a>
            <a id="modal-tx-link" href="#" target="_blank" class="block w-full text-center text-base font-mono text-white bg-indigo-500 hover:bg-indigo-400 py-3 rounded-lg font-bold transition shadow-lg hover:shadow-indigo-500/20">
                VIEW TRANSACTION ON SOLSCAN
            </a>
            
            <!-- NEW: TWEET LINK CONTAINER -->
            <div id="social-share-container" class="mt-2">
                <p id="social-loading" class="text-xs text-blue-400 animate-pulse font-mono mb-2">Broadcasting to X...</p>
                <a id="modal-tweet-link" href="#" target="_blank" class="hidden block w-full text-center text-base font-mono text-white bg-black border border-gray-700 hover:bg-gray-900 py-3 rounded-lg font-bold transition shadow-lg hover:shadow-blue-500/20">
                    üê¶ VIEW LAUNCH POST ON X
                </a>
            </div>

            <button onclick="closeSuccessModal()" class="block w-full text-center text-sm font-mono text-green-400 border border-green-800 hover:bg-green-900/50 py-2 rounded-lg transition mt-2">
                CLOSE & LAUNCH ANOTHER
            </button>
        </div>
    </div>
</div>

<script>
    const FRONTEND_VERSION = "v10.26.37";
    const BACKEND_URL = "https://asdev-1kvy.onrender.com";
    const DEV_WALLET_PUBKEY = "FNLWHjvjptwC7LxycdK3Knqcv5ptC19C9rynn6u2S1tB";
    const DEPLOYMENT_FEE = 0.02;
    const PUMPFUN_URL_BASE = "https://pump.fun/coin/";
    const PUMP_CONTRACT = "pumpCmXqMfrsAkQ5r49WcJnRayYRqmXz6ae8H7H9Dfn";

    // Wallet state
    let activeWalletProvider = null;
    let connectedWalletType = null;
    let userPubkey = null;
    let allLogs = []; 
    let pumpPriceCache = 0.0;
    let isDeploying = false;
    let nextCheckTime = 0;
    
    // NEW: System Status Tracker
    let systemStatus = {
        backend: 'CHECKING',
        solana_rpc: 'CHECKING',
        db_access: 'CHECKING', // Inferred from successful data fetches
        error_message: null
    };

    // Cached global values for calculation
    let currentPumpHoldings = 0;
    let currentGlobalPoints = 0;
    let currentUserPoints = 0;

    // XSS Sanitization helper
    const sanitize = (html) => DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'span', 'div', 'a', 'br', 'img', 'table', 'tr', 'td', 'th', 'thead', 'tbody'],
        ALLOWED_ATTR: ['href', 'target', 'class', 'style', 'src', 'alt', 'width', 'height']
    });

    // Safe text escaping for user content
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };

    // Interval manager for cleanup
    const activeIntervals = [];
    const registerInterval = (id) => { activeIntervals.push(id); return id; };
    const clearAllIntervals = () => { activeIntervals.forEach(id => clearInterval(id)); activeIntervals.length = 0; };
    window.addEventListener('beforeunload', clearAllIntervals);

    // API retry helper with exponential backoff
    const fetchWithRetry = async (url, options = {}, maxRetries = 3, baseDelay = 1000) => {
        let lastError;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const res = await fetch(url, options);
                if (!res.ok && res.status >= 500) throw new Error(`Server error: ${res.status}`);
                return res;
            } catch (err) {
                lastError = err;
                if (attempt < maxRetries - 1) {
                    const delay = baseDelay * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }
        throw lastError;
    };

    const ui = {
        connectBtn: document.getElementById('connect-btn'), walletUI: document.getElementById('wallet-ui'), walletAddr: document.getElementById('wallet-addr'), walletBal: document.getElementById('wallet-bal'),
        refreshBtn: document.getElementById('refresh-btn'), disconnectBtn: document.getElementById('disconnect-btn'), deployBtn: document.getElementById('deploy-btn'),
        statusBox: document.getElementById('status-msg'), sysStatus: document.getElementById('sys-status'), imgPreview: document.getElementById('image-preview'),
        previewName: document.getElementById('preview-name'), previewTicker: document.getElementById('preview-ticker'), lifetimeFees: document.getElementById('lifetime-fees'),
        logFeed: document.getElementById('log-feed'), headerImage: document.getElementById('header-image'), mayhemToggle: document.getElementById('mayhem-toggle'),
        mayhemStatusLabel: document.getElementById('mayhem-status-label'), logModal: document.getElementById('log-modal'), modalLogContent: document.getElementById('modal-log-content'),
        aboutModal: document.getElementById('about-modal'), successModal: document.getElementById('success-modal'),
        tickerContent: document.getElementById('ticker-content'), leaderboardBody: document.getElementById('leaderboard-body'), versionDisplay: document.getElementById('version-display'),
        metricLaunches: document.getElementById('metric-launches'), metricPump: document.getElementById('metric-pump'), metricFees: document.getElementById('metric-fees'),
        trackBalance: document.getElementById('track-balance'), trackLastAmt: document.getElementById('track-last-amt'), trackLastTime: document.getElementById('track-last-time'), trackNextCheck: document.getElementById('track-next-check'),
        leaderboardLastUpdated: document.getElementById('leaderboard-last-updated'),
        airdropBalance: document.getElementById('airdrop-balance'), // airdropValueSol removed from UI reference
        userTopPositions: document.getElementById('user-top-positions'), 
        userCreatedPositions: document.getElementById('user-created-positions'), // NEW ID
        asdfStatus: document.getElementById('asdf-status'),
        userTotalPoints: document.getElementById('user-total-points'), pointsMultiplierBadge: document.getElementById('points-multiplier-badge'),
        expectedAirdrop: document.getElementById('expected-airdrop'),
        airdropLogModal: document.getElementById('airdrop-log-modal'), modalAirdropLogContent: document.getElementById('modal-airdrop-log-content'),
        // NEW MODAL REFERENCES
        allLaunchesModal: document.getElementById('all-launches-modal'),
        modalAllLaunchesContent: document.getElementById('modal-all-launches-content'),
        allEligibleUsersModal: document.getElementById('all-eligible-users-modal'),
        modalAllEligibleUsersContent: document.getElementById('modal-all-eligible-users-content'),
        // NEW INFO MODAL REFERENCE
        airdropInfoModal: document.getElementById('airdrop-info-modal'),
        statusModal: document.getElementById('status-modal'),
        statusDetailsList: document.getElementById('status-details-list'),
        // SOCIAL REFERENCES
        socialLoading: document.getElementById('social-loading'),
        modalTweetLink: document.getElementById('modal-tweet-link'),
        // WALLET MODAL
        walletModal: document.getElementById('wallet-modal')
    };

    lucide.createIcons();
    
    // Function to copy CA to clipboard
    const copyCA = () => {
        const ca = ui.successModal.querySelector('#modal-mint-addr').textContent;
        // Use the old execCommand method for broader compatibility in sandboxed environments
        const tempInput = document.createElement('textarea');
        tempInput.value = ca;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        showStatus("Contract Address copied to clipboard!", 'success');
    };
    window.copyCA = copyCA; // Expose globally for the onclick event in HTML

    fetch(`${BACKEND_URL}/api/version`).then(r=>r.json()).then(d=>ui.versionDisplay.innerText = `${FRONTEND_VERSION} | BE: ${d.version}`).catch(()=>{});

    // Simple number formatter for MCAP (e.g., 12.5K, 1.2M)
    const formatMcap = (num) => {
        if (!num || num === 0) return "$0";
        if (num >= 1000000) return "$" + (num / 1000000).toFixed(2) + "M";
        if (num >= 1000) return "$" + (num / 1000).toFixed(1) + "K";
        return "$" + num.toLocaleString();
    };

    const updatePumpPrice = async () => {
        try {
            const res = await fetch(`https://frontend-api.pump.fun/coins/${PUMP_CONTRACT}`);
            const data = await res.json();
            if (data && data.virtual_sol_reserves && data.virtual_token_reserves) {
                pumpPriceCache = data.virtual_sol_reserves / data.virtual_token_reserves;
            }
        } catch (e) {}
    };

    const updateLeaderboard = async () => {
        try {
            const endpoint = `${BACKEND_URL}/api/leaderboard${userPubkey ? '?userPubkey='+userPubkey : ''}`;
            const res = await fetchWithRetry(endpoint);
            const data = await res.json();
            
            // Update DB status based on successful data retrieval
            systemStatus.db_access = 'ONLINE';
            
            // Handle the structured response from updated backend
            const tokens = data.tokens || [];
            const lastUpdate = data.lastUpdate;

            if (lastUpdate) {
                 const backendTime = new Date(lastUpdate).toLocaleTimeString();
                 ui.leaderboardLastUpdated.innerText = `Synced: ${backendTime}`;
            } else {
                 ui.leaderboardLastUpdated.innerText = `Synced: ${new Date().toLocaleTimeString()}`;
            }

            if (!tokens || tokens.length === 0) { ui.leaderboardBody.innerHTML = '<tr><td colspan="5" class="text-center text-orange-400 py-4">No active tokens found.</td></tr>'; return; }
            ui.leaderboardBody.innerHTML = await Promise.all(tokens.map(async (item, index) => {
                let displayMcap = item.marketCap; // Default from backend (Pump API)
                let displayVol = parseFloat(item.volume);
                
                let tradeLink = `${PUMPFUN_URL_BASE}${item.mint}`;
                let badge = `<span class="badge-bonding" title="Bonding in Progress">PRE-BOND</span>`; 

                // If complete (Post-Bond), attempt to fetch real data from DexScreener
                if (item.complete) {
                    badge = `<span class="badge-bonded" title="Bonding Curve Complete">BONDED</span>`;
                    tradeLink = `${PUMPFUN_URL_BASE}${item.mint}`; 
                    try {
                        const dexRes = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${item.mint}`);
                        const dexData = await dexRes.json();
                        if (dexData.pairs && dexData.pairs.length > 0) {
                            const pair = dexData.pairs[0];
                            if (pair.fdv) displayMcap = pair.fdv;
                            else if (pair.marketCap) displayMcap = pair.marketCap;
                            displayVol = pair.volume.h24;
                        }
                    } catch (e) { console.error("DEX fetch failed", e); }
                }

                let imgSrc = item.image;
                if ((!imgSrc || imgSrc.trim() === '') && item.metadataUri) {
                    try {
                        const metaRes = await fetch(item.metadataUri);
                        const metaJson = await metaRes.json();
                        if (metaJson.image) {
                            imgSrc = metaJson.image;
                        }
                    } catch (e) { console.error("Metadata fetch failed", e); }
                }
                
                if (!imgSrc || imgSrc.trim() === '') {
                    imgSrc = 'https://placehold.co/32x32/333/fff?text=?'; 
                }

                // Check for HOLDER status (from backend API logic)
                const holderMark = item.isUserTopHolder 
                    ? `<span class="holder-check" title="You are a Top Holder">üëë TOP HOLDER</span>` 
                    : '';
                
                // NEW: Check for CREATOR status (from user pubkey match)
                // item.creator is returned by backend now
                const creatorMark = (userPubkey && item.creator && userPubkey === item.creator)
                    ? `<span class="badge-creator" title="You created this token">üõ†Ô∏è CREATOR</span>`
                    : '';
                
                return `
                <tr>
                    <td class="text-orange-500 font-bold">${index + 1}</td>
                    <td>
                        <img src="${escapeHtml(imgSrc)}" onerror="this.src='https://placehold.co/32x32/333/fff?text=?'" class="token-img-sm" alt="icon">
                        <span class="text-white font-bold">${escapeHtml(item.ticker)}</span>
                        ${creatorMark}
                        ${holderMark}
                        ${badge}
                        <div class="text-[10px] text-orange-300 mt-1 truncate max-w-[150px]">${escapeHtml(item.name)}</div>
                    </td>
                    <!-- REMOVED NAME COLUMN -->
                    <td class="text-right text-green-400 font-bold font-mono">${formatMcap(displayMcap)}</td>
                    <td class="text-right text-white font-bold">$${displayVol.toLocaleString()}</td>
                    <td class="text-right">
                        <div class="flex gap-2 justify-end items-center">
                            <button onclick="viewTokenHolders('${escapeHtml(item.mint)}', '${escapeHtml(item.ticker)}')" class="text-xs bg-blue-900/50 border border-blue-700 text-blue-300 px-2 py-1 rounded hover:bg-blue-800 hover:text-white transition" title="View Top 50 Holders">
                                üë•
                            </button>
                            <a href="${escapeHtml(tradeLink)}" target="_blank" class="text-xs bg-orange-900/50 border border-orange-700 text-orange-300 px-2 py-1 rounded hover:bg-orange-800 hover:text-white transition">TRADE</a>
                        </div>
                    </td>
                </tr>`;
            })).then(rows => rows.join(''));

        } catch (e) {
            systemStatus.db_access = 'OFFLINE';
        }
    };
    window.updateLeaderboard = updateLeaderboard;

    // NEW: Function to View Token Holders
    const viewTokenHolders = async (mint, ticker) => {
        const modal = document.getElementById('holders-modal');
        const list = document.getElementById('holders-list');
        const title = document.getElementById('holders-modal-title');
        
        modal.style.display = 'block';
        title.innerText = `TOP 50: $${ticker}`;
        list.innerHTML = '<div class="text-center text-orange-400 p-4">Loading holder data...</div>';

        try {
            const res = await fetch(`${BACKEND_URL}/api/token-holders/${escapeHtml(mint)}`);
            if (!res.ok) throw new Error("Failed to fetch");
            const holders = await res.json();

            if (holders.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 p-4">No holder data available yet.</div>';
                return;
            }

            let html = '<table class="w-full text-left text-orange-200">';
            html += '<thead><tr class="text-orange-500 border-b border-orange-800/50"><th class="py-2">#</th><th class="py-2">Wallet</th></tr></thead><tbody>';

            holders.forEach(h => {
                const shortWallet = escapeHtml(h.holderPubkey?.slice(0, 5) || '?????');
                html += `<tr class="border-b border-orange-900/20 hover:bg-orange-900/10">
                            <td class="py-1 text-orange-400 font-bold w-12">${parseInt(h.rank) || 0}</td>
                            <td class="py-1 font-mono">${shortWallet}...</td>
                         </tr>`;
            });

            html += '</tbody></table>';
            list.innerHTML = html;
        } catch (e) {
            list.innerHTML = '<div class="text-center text-red-400 p-4">Failed to load holders.</div>';
        }
    };
    
    const closeHoldersModal = () => { document.getElementById('holders-modal').style.display = 'none'; };
    window.closeHoldersModal = closeHoldersModal;
    // Make sure viewTokenHolders is global so the onclick works
    window.viewTokenHolders = viewTokenHolders;


    // Fix: Updated to handle small, non-zero values by using higher precision display.
    const updateExpectedAirdropDisplay = (expectedAmount) => {
        const amount = parseFloat(expectedAmount);
        if (amount > 0 && amount < 0.1) { // If amount is small (e.g., < 0.1 PUMP)
            // Use high precision (e.g., 6 significant digits) to prevent rounding to 0.00
            ui.expectedAirdrop.innerText = amount.toPrecision(6);
        } else {
            // Otherwise, use standard formatting (max 2 decimal places, for larger amounts)
            ui.expectedAirdrop.innerText = amount.toLocaleString('en-US', {maximumFractionDigits: 2});
        }
    };
    
    // Removed unused call
    // window.calculateExpectedAirdrop = calculateExpectedAirdrop;

    const checkAsdfStatus = async () => {
        if (!userPubkey) {
            ui.asdfStatus.innerText = "NOT CONNECTED";
            ui.asdfStatus.className = "text-sm font-bold font-mono text-gray-500";
            ui.userTopPositions.innerText = "0";
            ui.userCreatedPositions.innerText = "0"; // Reset creator stats
            ui.userTotalPoints.innerText = "0";
            ui.pointsMultiplierBadge.classList.add('hidden');
            currentUserPoints = 0;
            updateExpectedAirdropDisplay(0); // Set to 0 if disconnected
            return;
        }
        
        ui.asdfStatus.innerText = "CHECKING...";
        try {
            // Updated endpoint query to include expectedAirdrop
            const res = await fetch(`${BACKEND_URL}/api/check-holder?userPubkey=${userPubkey}`);
            const data = await res.json();
            
            // Update Top Position Count (Base Points)
            ui.userTopPositions.innerText = data.heldPositionsCount || 0;
            
            // Update Created Position Points (count * 2)
            ui.userCreatedPositions.innerText = (data.createdPositionsCount || 0) * 2;

            // Update ASDF Status
            if (data.isAsdfTop50) {
                ui.asdfStatus.innerText = "YES (QUALIFIED)";
                ui.asdfStatus.className = "text-sm font-bold font-mono text-green-400 animate-pulse";
                ui.pointsMultiplierBadge.classList.remove('hidden');
            } else {
                ui.asdfStatus.innerText = "NO";
                ui.asdfStatus.className = "text-sm font-bold font-mono text-red-400";
                ui.pointsMultiplierBadge.classList.add('hidden');
            }

            // Update Total Points
            currentUserPoints = data.points || 0;
            ui.userTotalPoints.innerText = currentUserPoints;
            
            // NEW: Use pre-calculated expected airdrop amount
            updateExpectedAirdropDisplay(data.expectedAirdrop);

        } catch (e) {
            console.error("ASDF/Points Check Error", e);
            ui.asdfStatus.innerText = "ERROR";
            updateExpectedAirdropDisplay(0);
        }
    };

    const fetchRecentLaunches = async () => { 
        // Explicitly set fetching status right before network call
        ui.tickerContent.innerHTML = '<span class="ticker-item text-orange-600">FETCHING LAUNCH FEED... PLEASE WAIT...</span>';

        try { 
            const res = await fetch(`${BACKEND_URL}/api/recent-launches`); 
            if (res.ok) { 
                // Nothing to update in system status, success is implied by content load.
                const launches = await res.json(); 
                if (launches.length === 0) { 
                    ui.tickerContent.innerHTML = '<span class="ticker-item text-orange-600">NO RECENT LAUNCHES YET... START ONE!</span>'; 
                    return; 
                } 
                const repeatedLaunches = Array(5).fill(launches).flat();
                const tickerItems = repeatedLaunches.map(launch => `<span class="ticker-item"><span class="text-white font-bold">LAUNCHED:</span><span class="text-white">${escapeHtml(launch.userSnippet)}...</span><span class="text-orange-400">-></span><a href="${PUMPFUN_URL_BASE}${escapeHtml(launch.mint)}" target="_blank" class="font-bold underline">${escapeHtml(launch.ticker)}</a></span>`).join('');
                ui.tickerContent.innerHTML = tickerItems; 
            } else {
                // Server returned non-200 status
                 ui.tickerContent.innerHTML = '<span class="ticker-item text-red-500">ERROR: FAILED TO LOAD LAUNCH FEED (Server Issue)</span>'; 
            }
        } catch (e) {
            // Network error/timeout
            ui.tickerContent.innerHTML = '<span class="ticker-item text-red-500">ERROR: FAILED TO LOAD LAUNCH FEED (Network Error)</span>';
        } 
    };

    const checkHealth = async () => { 
        let status = 'ONLINE';
        let error = null;

        try {
            const res = await fetchWithRetry(`${BACKEND_URL}/api/health`);
            if (res.ok) { 
                const data = await res.json(); 
                
                // Set overall status based on backend self-assessment
                systemStatus.backend = data.status === 'online' ? 'ONLINE' : 'DEGRADED';
                
                ui.headerImage.src = data.headerImageUrl || "https://placehold.co/60x60/d97706/ffffff?text=LOGO"; 
                
                if (data.totalVolume !== undefined) {
                    ui.metricFees.innerText = "$" + (parseFloat(data.totalVolume) || 0).toLocaleString();
                } else if (data.lifetimeFees) {
                    ui.metricFees.innerText = data.lifetimeFees + " SOL"; 
                }
                
                if (data.totalLaunches) ui.metricLaunches.innerText = data.totalLaunches; 
                
                // Display Total Airdropped PUMP
                if (data.totalAirdropped !== undefined) {
                    ui.metricPump.innerText = parseFloat(data.totalAirdropped).toLocaleString('en-US', {maximumFractionDigits: 0});
                } else if (data.totalPumpTokensBought) {
                    // Fallback for backwards compatibility
                    ui.metricPump.innerText = data.totalPumpTokensBought;
                }

                allLogs = data.recentLogs; 
                
                if (data.currentFeeBalance) ui.trackBalance.innerText = data.currentFeeBalance;
                if (data.lastClaimAmount) ui.trackLastAmt.innerText = data.lastClaimAmount;
                if (data.lastClaimTime && data.lastClaimTime > 0) {
                    ui.trackLastTime.innerText = new Date(data.lastClaimTime).toLocaleString();
                } else {
                    ui.trackLastTime.innerText = "Never";
                }
                
                if (data.nextCheckTime) {
                    nextCheckTime = data.nextCheckTime;
                }

                if (data.pumpHoldings !== undefined) {
                    currentPumpHoldings = parseFloat(data.pumpHoldings);
                    ui.airdropBalance.innerHTML = `${currentPumpHoldings.toLocaleString('en-US', {maximumFractionDigits: 0})} <span class="text-lg align-top text-purple-400">$PUMP</span>`;
                    // REMOVED: ui.airdropValueSol.innerText = `‚âà ${estVal.toFixed(2)} SOL`;
                }
                
                if (data.totalPoints !== undefined) {
                    currentGlobalPoints = data.totalPoints;
                }

            } else { 
                status = 'OFFLINE';
                error = `Backend responded with status code: ${res.status}`;
            } 
        } catch (e) { 
            status = 'OFFLINE';
            error = `Failed to reach backend API. Check network connection or backend URL.`;
        } 
        
        // Finalize system status
        systemStatus.error_message = error;

        // Update main indicator based on most critical failure
        if (status === 'ONLINE' && systemStatus.solana_rpc !== 'OFFLINE') {
            ui.sysStatus.innerText = "ONLINE"; ui.sysStatus.classList.add("online");
        } else {
            ui.sysStatus.innerText = status === 'OFFLINE' ? "OFFLINE" : "DEGRADED";
            ui.sysStatus.classList.remove("online");
        }
    };

    registerInterval(setInterval(() => {
        if (nextCheckTime > 0) {
            const now = Date.now();
            const diff = nextCheckTime - now;
            if (diff > 0) {
                const min = Math.floor(diff / 60000);
                const sec = Math.floor((diff % 60000) / 1000);
                ui.trackNextCheck.innerText = `${min}:${sec < 10 ? '0' + sec : sec}`;
            } else {
                if (diff > -10000) ui.trackNextCheck.innerText = "Checking...";
                else ui.trackNextCheck.innerText = "Wait...";
            }
        }
    }, 1000));

    const refreshWalletBalance = async () => { 
        if (!userPubkey) { 
            systemStatus.solana_rpc = 'N/A';
            return; 
        }
        try {
            const res = await fetchWithRetry(`${BACKEND_URL}/api/balance?pubkey=${userPubkey}`);
            if (!res.ok) throw new Error("Balance fetch failed");
            const data = await res.json();
            const solBalance = data.balance / solanaWeb3.LAMPORTS_PER_SOL;
            ui.walletBal.innerText = solBalance.toFixed(3) + " SOL"; 
            
            systemStatus.solana_rpc = 'ONLINE'; // If the balance check passed, RPC is up
            
            if (!isDeploying) {
                if (solBalance < DEPLOYMENT_FEE) {
                    ui.deployBtn.disabled = true; ui.deployBtn.innerText = `INSUFFICIENT BALANCE (< ${DEPLOYMENT_FEE} SOL)`; ui.deployBtn.classList.add("opacity-50", "cursor-not-allowed");
                } else {
                    ui.deployBtn.disabled = false; ui.deployBtn.innerText = "INITIATE LAUNCH SEQUENCE"; ui.deployBtn.classList.remove("opacity-50", "cursor-not-allowed");
                }
            }
        } catch (e) { 
            console.error("Balance check error:", e); 
            systemStatus.solana_rpc = 'OFFLINE';
        } 
    };

    const refreshAllData = async () => {
        if (ui.refreshBtn) ui.refreshBtn.classList.add('opacity-50', 'cursor-wait');
        
        // Reset status checks at the start of the refresh cycle
        systemStatus.backend = 'CHECKING';
        systemStatus.db_access = 'CHECKING';
        systemStatus.solana_rpc = 'CHECKING';

        try {
            await Promise.allSettled([
                updatePumpPrice(),
                updateLeaderboard(),
                fetchRecentLaunches(),
                checkHealth(),
                refreshWalletBalance(),
                checkAsdfStatus() // Refresh user-specific data including expected airdrop
            ]);
        } catch (e) { console.error("Auto-Refresh Error", e); }
        
        // Re-run checkHealth to ensure the main indicator updates based on the final status of all checks
        checkHealth(); 
        
        if (ui.refreshBtn) ui.refreshBtn.classList.remove('opacity-50', 'cursor-wait');
    };
    window.refreshAllData = refreshAllData;

    registerInterval(setInterval(refreshAllData, 60000));
    refreshAllData();

    ui.refreshBtn.onclick = () => refreshAllData();

    // --- System Status Modal Logic ---
    const toggleStatusModal = () => {
        const list = ui.statusDetailsList;
        list.innerHTML = '';
        
        // Helper to generate status item HTML
        const generateStatusItem = (name, status, error) => {
            const isOnline = status === 'ONLINE';
            const colorClass = isOnline ? 'text-green' : 'text-red';
            const icon = isOnline ? 'check-circle' : 'x-circle';
            const statusText = isOnline ? 'ONLINE' : (status === 'OFFLINE' ? 'OFFLINE' : status);

            let itemHtml = `
                <div class="status-item">
                    <span class="font-bold text-white">${name}</span>
                    <div class="flex items-center">
                        <i data-lucide="${icon}" class="status-icon ${colorClass}" width="16"></i>
                        <span class="${colorClass} font-bold">${statusText}</span>
                    </div>
                </div>
            `;
            if (error) {
                itemHtml += `<div class="text-xs text-red-400 font-normal mt-1 pl-4">Error: ${error}</div>`;
            }
            return itemHtml;
        };

        let html = '';
        html += generateStatusItem("Backend API Server", systemStatus.backend, systemStatus.error_message);
        html += generateStatusItem("Database Read/Write", systemStatus.db_access, systemStatus.db_access === 'OFFLINE' ? "Failed to query SQLite DB (internal server issue)." : null);
        html += generateStatusItem("Solana RPC (Helius)", systemStatus.solana_rpc, systemStatus.solana_rpc === 'OFFLINE' ? "Failed Solana balance check via RPC." : null);
        
        list.innerHTML = html;
        lucide.createIcons();
        ui.statusModal.style.display = 'block';
    };
    window.toggleStatusModal = toggleStatusModal;

    const closeStatusModal = () => { ui.statusModal.style.display = 'none'; };
    window.closeStatusModal = closeStatusModal;
    // --- End System Status Modal Logic ---


    const updateMayhemLabel = () => { if (ui.mayhemToggle.checked) { ui.mayhemStatusLabel.innerText = "MAYHEM MODE: ON (HIGH RISK)"; ui.mayhemStatusLabel.classList.add('active'); } else { ui.mayhemStatusLabel.innerText = "MAYHEM MODE: OFF"; ui.mayhemStatusLabel.classList.remove('active'); } };
    ui.mayhemToggle.addEventListener('change', updateMayhemLabel); updateMayhemLabel(); 

    const updatePreview = () => { ui.previewName.innerText = document.getElementById('name').value || "Token Name"; ui.previewTicker.innerText = document.getElementById('ticker').value ? `$${document.getElementById('ticker').value.toUpperCase()}` : "$TICKER"; };
    
    // Updated previewImage to handle drag/drop and click upload
    const previewImage = (event) => { 
        const files = event.target.files || event.dataTransfer?.files;
        const file = files?.[0]; 

        if (file) { 
            const reader = new FileReader(); 
            reader.onload = (e) => { 
                ui.imgPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="rounded-lg w-full h-full object-cover">`; 
                ui.imgPreview.style.border = "2px solid #ea580c"; 
            }; 
            reader.readAsDataURL(file); 
        } else { 
            ui.imgPreview.innerHTML = `
                <div class="text-center pointer-events-none">
                    <div class="text-2xl mb-2">üìÅ</div>
                    <div class="text-xs font-bold text-orange-400">DRAG & DROP<br>OR CLICK TO UPLOAD</div>
                </div>`;
            ui.imgPreview.style.border = "2px dashed #7c2d12"; 
        } 
    };
    window.previewImage = previewImage; window.updatePreview = updatePreview;
    
    // DRAG AND DROP HANDLERS
    const dropZone = document.getElementById('image-preview');
    const fileInput = document.getElementById('image-file');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('drag-over');
    }

    function unhighlight(e) {
        dropZone.classList.remove('drag-over');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0 && files[0].type.startsWith('image/')) {
            // Create a new FileList object to assign to the file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files; 
            
            previewImage({ target: fileInput }); // Trigger existing preview logic using the file input
        } else {
             showStatus("Invalid file type dropped. Please use an image.", 'error');
        }
    }


    const closeSuccessModal = () => { ui.successModal.style.display = 'none'; };
    window.closeSuccessModal = closeSuccessModal;
    
    // --- MODAL FUNCTIONS ---

    // Function for All Launches Modal
    const toggleAllLaunchesModal = async () => {
        ui.allLaunchesModal.style.display = 'block';
        ui.modalAllLaunchesContent.innerHTML = '<div class="text-center text-orange-400 p-4">Fetching all token data...</div>';
        
        try {
            const res = await fetch(`${BACKEND_URL}/api/all-launches`);
            if (res.ok) {
                const data = await res.json();
                const tokens = data.tokens || [];
                
                if (tokens.length === 0) {
                    ui.modalAllLaunchesContent.innerHTML = '<div class="text-center text-gray-500 p-4">No tokens have been launched yet.</div>';
                    return;
                }
                
                const tableHTML = `
                    <table class="w-full text-left font-mono text-xs leader-table">
                        <thead class="text-orange-400 border-b border-orange-800">
                            <tr><th class="p-2">#</th><th class="p-2">Token</th><th class="p-2">Creator</th><th class="p-2 text-right">MCAP</th><th class="p-2 text-right">Vol (24H)</th><th class="p-2 text-right">Status</th></tr>
                        </thead>
                        <tbody class="text-orange-200">
                            ${await Promise.all(tokens.map(async (item, index) => {
                                // Re-use existing badge logic for status display
                                const badge = item.complete ? 
                                    '<span class="badge-bonded text-xs" style="background-color:#22c55e;">BONDED</span>' : 
                                    '<span class="badge-bonding text-xs" style="background-color:#eab308;">PRE-BOND</span>';
                                    
                                // Try to get image from token data or metadata URI
                                let imgSrc = item.image;
                                if ((!imgSrc || imgSrc.trim() === '') && item.metadataUri) {
                                    try {
                                        const metaRes = await fetch(item.metadataUri);
                                        const metaJson = await metaRes.json();
                                        if (metaJson.image) {
                                            imgSrc = metaJson.image;
                                        }
                                    } catch (e) { /* silent fail */ }
                                }
                                if (!imgSrc || imgSrc.trim() === '') {
                                    imgSrc = 'https://placehold.co/32x32/333/fff?text=?'; 
                                }

                                return `
                                <tr class="border-b border-orange-800/30 hover:bg-orange-900/20">
                                    <td class="p-2">${index + 1}</td>
                                    <td class="p-2">
                                        <img src="${escapeHtml(imgSrc)}" onerror="this.src='https://placehold.co/32x32/333/fff?text=?'" class="token-img-sm" alt="icon">
                                        <a href="${PUMPFUN_URL_BASE}${escapeHtml(item.mint)}" target="_blank" class="font-bold underline text-white">${escapeHtml(item.ticker)}</a> (${escapeHtml(item.name)})
                                    </td>
                                    <td class="p-2 text-orange-400">${escapeHtml(item.userPubkey?.slice(0, 5) || '?????')}...</td>
                                    <td class="p-2 text-right font-bold text-green-400">${formatMcap(item.marketCap)}</td>
                                    <td class="p-2 text-right font-bold">$${(parseFloat(item.volume) || 0).toLocaleString()}</td>
                                    <td class="p-2 text-right">${badge}</td>
                                </tr>
                                `;
                            })).then(rows => rows.join(''))}
                        </tbody>
                    </table>
                `;
                ui.modalAllLaunchesContent.innerHTML = tableHTML;
            } else {
                throw new Error("Failed to fetch all launches.");
            }
        } catch(e) {
            ui.modalAllLaunchesContent.innerHTML = `<div class="text-center text-red-400 p-4">Error: ${escapeHtml(e.message)}</div>`;
        }
    };
    window.toggleAllLaunchesModal = toggleAllLaunchesModal;
    const closeAllLaunchesModal = () => { ui.allLaunchesModal.style.display = 'none'; };
    window.closeAllLaunchesModal = closeAllLaunchesModal;

    // Function for All Eligible Users Modal
    const toggleAllEligibleUsersModal = async () => {
        ui.allEligibleUsersModal.style.display = 'block';
        ui.modalAllEligibleUsersContent.innerHTML = '<div class="text-center text-purple-400 p-4">Calculating all eligible users...</div>';

        try {
            const res = await fetch(`${BACKEND_URL}/api/all-eligible-users`);
            if (res.ok) {
                const data = await res.json();
                const users = data.users || [];
                
                if (users.length === 0) {
                    ui.modalAllEligibleUsersContent.innerHTML = '<div class="text-center text-gray-500 p-4">No users currently qualify for the airdrop (0 global points).</div>';
                    return;
                }
                
                const tableHTML = `
                    <p class="text-purple-300 font-mono text-sm mb-4">Total Global Points: <span class="text-white font-bold">${data.totalPoints.toLocaleString()}</span> | Total Eligible Users: <span class="text-white font-bold">${users.length}</span></p>
                    <table class="w-full text-left font-mono text-xs">
                        <thead class="text-purple-400 border-b border-purple-800">
                            <tr><th class="p-2">#</th><th class="p-2">Wallet (Snippet)</th><th class="p-2 text-right">Holder Pts</th><th class="p-2 text-right">Creator Pts</th><th class="p-2 text-right">Multiplier</th><th class="p-2 text-right">Points</th><th class="p-2 text-right">Est. Airdrop</th></tr>
                        </thead>
                        <tbody class="text-purple-200">
                            ${users.sort((a, b) => b.points - a.points).map((user, index) => {
                                const multiplierBadge = user.isAsdfTop50 
                                    ? '<span class="px-2 py-0.5 bg-green-500/20 border border-green-500 rounded text-[9px] text-green-400 font-bold">2X (ASDF)</span>' 
                                    : '<span class="px-2 py-0.5 bg-gray-500/20 border border-gray-500 rounded text-[9px] text-gray-400 font-bold">1X</span>';
                                    
                                return `
                                <tr class="border-b border-purple-800/30 hover:bg-purple-900/20">
                                    <td class="p-2">${index + 1}</td>
                                    <td class="p-2 text-white font-bold">${escapeHtml(user.pubkey?.slice(0, 5) || '?????')}...</td>
                                    <td class="p-2 text-right">${user.positions}</td>
                                    <td class="p-2 text-right text-blue-400">${(user.created || 0) * 2}</td>
                                    <td class="p-2 text-right">${multiplierBadge}</td>
                                    <td class="p-2 text-right text-yellow-400 font-bold">${user.points}</td>
                                    <td class="p-2 text-right text-green-400 font-bold">${parseFloat(user.expectedAirdrop).toLocaleString('en-US', {maximumFractionDigits: 2})} $PUMP</td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                ui.modalAllEligibleUsersContent.innerHTML = tableHTML;
            } else {
                throw new Error("Failed to fetch eligible users.");
            }
        } catch(e) {
            ui.modalAllEligibleUsersContent.innerHTML = `<div class="text-center text-red-400 p-4">Error: ${escapeHtml(e.message)}</div>`;
        }
    };
    window.toggleAllEligibleUsersModal = toggleAllEligibleUsersModal;
    const closeAllEligibleUsersModal = () => { ui.allEligibleUsersModal.style.display = 'none'; };
    window.closeAllEligibleUsersModal = closeAllEligibleUsersModal;

    // Function for Airdrop Info Modal (New Disclaimer)
    const toggleAirdropInfoModal = () => { 
        ui.airdropInfoModal.style.display = 'block'; 
        // Force lucide icons to render inside the new modal content if they weren't before
        lucide.createIcons();
    };
    window.toggleAirdropInfoModal = toggleAirdropInfoModal;
    const closeAirdropInfoModal = () => { ui.airdropInfoModal.style.display = 'none'; };
    window.closeAirdropInfoModal = closeAirdropInfoModal;

    // IMPROVED: Buyback Logs Toggle Function
    const toggleLogModal = () => { 
        ui.modalLogContent.innerHTML = ''; 
        if(allLogs && allLogs.length > 0) {
            ui.modalLogContent.innerHTML = allLogs.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                let logDetailsHtml = '';
                
                // Fields to exclude from the detailed view (already shown in header or not needed)
                const excludedKeys = ['type', 'timestamp'];
                
                // Helper to format keys like "feesCollected" -> "Fees Collected"
                const formatKey = (str) => str.replace(/([A-Z])/g, ' $1').trim();

                // Generate badge based on Status
                let statusBadge = '';
                if (log.status) {
                    let badgeClass = 'badge-skipped'; // Default orange
                    if (log.status === 'SUCCESS') badgeClass = 'badge-success';
                    else if (log.status.includes('FAIL') || log.status.includes('ERROR')) badgeClass = 'badge-error';
                    statusBadge = `<span class="status-badge ${badgeClass}">${log.status}</span>`;
                }

                // Iterate over object keys to create grid rows
                for (const [key, value] of Object.entries(log)) {
                    if (excludedKeys.includes(key)) continue;
                    
                    let displayValue = value;
                    if (key.toLowerCase().includes('sol') || key.toLowerCase().includes('fees')) {
                        // Attempt to format numbers if they look like SOL amounts
                        const numVal = parseFloat(value);
                        if (!isNaN(numVal)) displayValue = numVal.toFixed(4) + ' SOL';
                    }

                    logDetailsHtml += `
                        <div class="log-grid">
                            <span class="log-label">${formatKey(key)}:</span>
                            <span class="log-value">${displayValue}</span>
                        </div>
                    `;
                }

                return `
                <div class="log-entry">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-orange-500 font-bold">[${time}] ${log.type}</span>
                        ${statusBadge}
                    </div>
                    <div class="bg-black/20 p-2 rounded border border-orange-900/30">
                        ${logDetailsHtml}
                    </div>
                </div>`;
            }).join('');
        } else {
            ui.modalLogContent.innerHTML = '<p class="text-center text-orange-400">No logs yet.</p>';
        }
        ui.logModal.style.display = 'block'; 
    };
    window.toggleLogModal = toggleLogModal;
    const closeLogModal = () => { ui.logModal.style.display = 'none'; };
    window.closeLogModal = closeLogModal;

    // Wallet Modal Functions
    const openWalletModal = () => {
        // Detect available wallets
        if (window.phantom?.solana) document.getElementById('tag-phantom')?.classList.remove('hidden');
        if (window.solflare) document.getElementById('tag-solflare')?.classList.remove('hidden');
        if (window.backpack) document.getElementById('tag-backpack')?.classList.remove('hidden');
        ui.walletModal.style.display = 'block';
        lucide.createIcons();
    };
    window.openWalletModal = openWalletModal;

    const closeWalletModal = () => { ui.walletModal.style.display = 'none'; };
    window.closeWalletModal = closeWalletModal;

    const selectWallet = async (walletType) => {
        closeWalletModal();
        try {
            let provider = null;
            if (walletType === 'phantom' && window.phantom?.solana) {
                provider = window.phantom.solana;
            } else if (walletType === 'solflare' && window.solflare) {
                provider = window.solflare;
            } else if (walletType === 'backpack' && window.backpack) {
                provider = window.backpack;
            }

            if (!provider) {
                showStatus(`${walletType} wallet not detected. Please install it.`, 'error');
                return;
            }

            const resp = await provider.connect();
            activeWalletProvider = provider;
            connectedWalletType = walletType;
            userPubkey = resp.publicKey.toString();

            ui.connectBtn.classList.add('hidden');
            ui.walletUI.classList.remove('hidden');
            ui.walletAddr.innerText = userPubkey.slice(0, 4) + "..." + userPubkey.slice(-4);

            refreshWalletBalance();
            updateHolderStatus();
            showStatus(`Connected to ${walletType}!`, 'success');
        } catch (e) {
            showStatus("Wallet connection failed: " + e.message, 'error');
        }
    };
    window.selectWallet = selectWallet;

    // UPDATED: Airdrop Log Toggle with DATE in timestamp
    const toggleAirdropLogModal = async () => {
        ui.airdropLogModal.style.display = 'block';
        ui.modalAirdropLogContent.innerHTML = '<div class="text-center text-purple-400 p-4">Loading History...</div>';
        try {
            const res = await fetch(`${BACKEND_URL}/api/airdrop-logs`);
            if (res.ok) {
                const logs = await res.json();
                if (logs.length === 0) {
                    ui.modalAirdropLogContent.innerHTML = '<div class="text-center text-gray-500 p-4">No airdrops distributed yet.</div>';
                    return;
                }
                
                ui.modalAirdropLogContent.innerHTML = `
                    <table class="w-full text-left font-mono text-xs">
                        <thead class="text-purple-400 border-b border-purple-800">
                            <tr><th class="p-2">Date/Time</th><th class="p-2">Amount</th><th class="p-2">Users</th><th class="p-2">Total Pts</th><th class="p-2 text-right">TXs</th></tr>
                        </thead>
                        <tbody class="text-purple-200">
                            ${logs.map(log => `
                                <tr class="border-b border-purple-800/30 hover:bg-purple-900/20">
                                    <td class="p-2">${new Date(log.timestamp).toLocaleString()}</td> 
                                    <td class="p-2 font-bold text-green-400">${parseFloat(log.amount).toFixed(2)}</td>
                                    <td class="p-2">${log.recipients}</td>
                                    <td class="p-2">${log.totalPoints || '-'}</td>
                                    <td class="p-2 text-right">
                                        ${log.signatures ? log.signatures.split(',').map((sig, i) => 
                                            `<a href="https://solscan.io/tx/${sig}" target="_blank" class="tx-link">[TX ${i+1}]</a>`
                                        ).join(' ') : 'Pending'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        } catch(e) {
            ui.modalAirdropLogContent.innerHTML = '<div class="text-center text-red-400 p-4">Failed to load logs.</div>';
        }
    };
    window.toggleAirdropLogModal = toggleAirdropLogModal;
    const closeAirdropLogModal = () => { ui.airdropLogModal.style.display = 'none'; };
    window.closeAirdropLogModal = closeAirdropLogModal;

    const toggleAboutModal = () => { ui.aboutModal.style.display = 'block'; };
    window.toggleAboutModal = toggleAboutModal;
    const closeAboutModal = () => { ui.aboutModal.style.display = 'none'; };
    window.closeAboutModal = closeAboutModal;

    const showStatus = (msg, type) => { ui.statusBox.innerText = msg; ui.statusBox.style.display = 'block'; if (type === 'error') ui.statusBox.className = 'status-box status-error'; else if (type === 'success') ui.statusBox.className = 'status-box status-success'; else ui.statusBox.className = 'status-box'; };
    const toBase64 = file => new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); });

    const updateWalletUI = async (pubkey) => {
        if (!pubkey) {
            ui.walletUI.classList.add('hidden');
            ui.connectBtn.classList.remove('hidden');
            updateLeaderboard(); // Update to remove user-specific data on disconnect
            checkAsdfStatus(); // Reset status display
            return;
        }
        userPubkey = pubkey.toString();
        ui.connectBtn.classList.add('hidden');
        ui.walletUI.classList.remove('hidden');
        ui.walletUI.classList.add('flex');
        ui.walletAddr.innerText = userPubkey.slice(0, 4) + '...' + userPubkey.slice(-4);
        await refreshWalletBalance();
        updateLeaderboard(); // Update to show user-specific data on connect
        checkAsdfStatus();
    };

    // --- NEW WALLET CONNECTION LOGIC ---

    const openWalletModal = () => {
        // Detect wallets and update UI
        if (window.solana && window.solana.isPhantom) document.getElementById('tag-phantom').classList.remove('hidden');
        if (window.solflare && window.solflare.isSolflare) document.getElementById('tag-solflare').classList.remove('hidden');
        if (window.backpack || window.xnft) document.getElementById('tag-backpack').classList.remove('hidden');

        ui.walletModal.style.display = 'block';
        lucide.createIcons();
    };
    window.openWalletModal = openWalletModal;
    
    const closeWalletModal = () => { ui.walletModal.style.display = 'none'; };
    window.closeWalletModal = closeWalletModal;

    const selectWallet = async (type) => {
        let provider = null;
        let installUrl = "https://phantom.app";

        if (type === 'phantom') {
            provider = window.solana?.isPhantom ? window.solana : null;
            installUrl = "https://phantom.app/";
        } else if (type === 'solflare') {
            provider = window.solflare;
            installUrl = "https://solflare.com/";
        } else if (type === 'backpack') {
            provider = window.backpack || window.xnft?.solana;
            installUrl = "https://backpack.app/";
        }

        if (!provider) {
            window.open(installUrl, '_blank');
            showStatus(`${type.toUpperCase()} not detected. Opening download page...`, 'error');
            return;
        }

        try {
            const resp = await provider.connect();
            activeWalletProvider = provider;
            connectedWalletType = type;
            
            // Save to localStorage for auto-connect
            localStorage.setItem('connectedWalletType', type);
            
            // Handle different response structures
            let pubkey = resp.publicKey;
            if (!pubkey && provider.publicKey) pubkey = provider.publicKey;
            
            await updateWalletUI(pubkey);
            closeWalletModal();
            showStatus(`Connected to ${type.toUpperCase()}`, 'success');

        } catch (err) {
            console.error("Connection Error:", err);
            showStatus("Connection Rejected", 'error');
        }
    };
    window.selectWallet = selectWallet;

    const disconnectWallet = async () => { 
        if (activeWalletProvider) { 
            try { await activeWalletProvider.disconnect(); } catch (e) {} 
        } else if (window.solana) {
             try { await window.solana.disconnect(); } catch (e) {} 
        }
        
        userPubkey = null; 
        activeWalletProvider = null;
        localStorage.removeItem('connectedWalletType');
        updateWalletUI(null); 
    };
    ui.disconnectBtn.onclick = disconnectWallet;


    const validateInputs = (name, ticker, description, twitter, website, fileInput) => {
        if (fileInput.files.length === 0) return "Image is required.";
        const file = fileInput.files[0];
        if (file.size > 4 * 1024 * 1024) return "Image size must be less than 4MB.";
        if (!name || name.trim().length === 0) return "Token Name is required.";
        if (name.length > 32) return "Token Name must be 32 characters or less.";
        if (!ticker || ticker.trim().length === 0) return "Ticker Symbol is required.";
        if (ticker.length > 11) return "Ticker must be 11 characters or less.";
        if (description.length > 75) return "Description must be 75 characters or less.";
        const urlPattern = /^(https?:\/\/[^\s]+|([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/[^\s]*)?)$/;
        if (twitter && twitter.trim() !== '' && !urlPattern.test(twitter)) return "Invalid Twitter URL.";
        if (website && website.trim() !== '' && !urlPattern.test(website)) return "Invalid Website URL.";
        return null;
    };

    ui.deployBtn.onclick = async () => {
        if (!userPubkey || !activeWalletProvider) return showStatus("CONNECT WALLET FIRST", 'error');
        const name = document.getElementById('name').value;
        const ticker = document.getElementById('ticker').value;
        const description = document.getElementById('desc').value;
        const twitter = document.getElementById('twitter').value;
        const website = document.getElementById('website').value;
        const fileInput = document.getElementById('image-file');
        const isMayhemMode = ui.mayhemToggle.checked;
        
        const validationError = validateInputs(name, ticker, description, twitter, website, fileInput);
        if (validationError) return showStatus(validationError.toUpperCase(), 'error');

        let imageBase64;
        try { imageBase64 = await toBase64(fileInput.files[0]); } catch(e) { return showStatus("IMAGE PROCESSING FAILED", 'error'); }

        isDeploying = true; // Lock button
        ui.deployBtn.disabled = true; 
        ui.deployBtn.innerText = "UPLOADING & VERIFYING METADATA..."; 
        showStatus("PREPARING METADATA...", 'normal');

        try {
            const prepRes = await fetchWithRetry(`${BACKEND_URL}/api/prepare-metadata`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, ticker, description, twitter, website, image: imageBase64 })
            }, 2); // 2 retries for metadata upload

            if (!prepRes.ok) {
                const errData = await prepRes.json();
                throw new Error(errData.error || "Metadata upload failed");
            }
            const { metadataUri } = await prepRes.json();

            ui.deployBtn.innerText = "SIGNING FEE TRANSACTION...";
            showStatus("METADATA READY. PLEASE SIGN WALLET...", 'normal');

            const bhRes = await fetchWithRetry(`${BACKEND_URL}/api/blockhash`);
            if (!bhRes.ok) throw new Error("Failed to fetch blockhash from backend");
            const { blockhash } = await bhRes.json();

            const tx = new solanaWeb3.Transaction();
            const modifyComputeUnits = solanaWeb3.ComputeBudgetProgram.setComputeUnitLimit({ units: 200000 });
            const addPriorityFee = solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: 100000 });
            tx.add(modifyComputeUnits);
            tx.add(addPriorityFee);

            tx.add(
                solanaWeb3.SystemProgram.transfer({
                    fromPubkey: new solanaWeb3.PublicKey(userPubkey),
                    toPubkey: new solanaWeb3.PublicKey(DEV_WALLET_PUBKEY),
                    lamports: DEPLOYMENT_FEE * 1000000000 
                })
            );
            
            tx.recentBlockhash = blockhash;
            tx.feePayer = new solanaWeb3.PublicKey(userPubkey);
            
            // UPDATED: USE ACTIVE PROVIDER
            const signedTx = await activeWalletProvider.signAndSendTransaction(tx);
            
            // Handle different return types (some return object with signature, some return raw string)
            const txSignature = signedTx.signature || signedTx;

            ui.deployBtn.innerText = "QUEUING DEPLOYMENT...";
            showStatus("PAYMENT CONFIRMED. QUEUING...", 'normal');

            const deployRes = await fetchWithRetry(`${BACKEND_URL}/api/deploy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name, ticker, description, twitter, website,
                    metadataUri,
                    userTx: txSignature,
                    userPubkey: userPubkey,
                    isMayhemMode: isMayhemMode
                })
            }, 2);

            const data = await deployRes.json();
            if (data.success && data.jobId) {
                ui.deployBtn.innerText = "DEPLOYING...";
                pollJobStatus(data.jobId);
            } else { throw new Error(data.error); }

        } catch (e) {
            console.error(e);
            showStatus("ERROR: " + (e.message || "Process failed."), 'error');
            isDeploying = false; // Unlock button logic
            refreshWalletBalance(); // Reset button state
        }
    };

    // POLL JOB STATUS
    const pollJobStatus = async (jobId) => {
        let attempts = 0;
        const maxAttempts = 150; // 5 minutes max (2s * 150)

        const interval = setInterval(async () => {
            attempts++;
            if (attempts > maxAttempts) {
                clearInterval(interval);
                showStatus("DEPLOYMENT TIMEOUT - Check status manually", 'error');
                isDeploying = false;
                ui.deployBtn.disabled = false; ui.deployBtn.innerText = "CHECK STATUS";
                return;
            }

            try {
                const res = await fetch(`${BACKEND_URL}/api/job-status/${jobId}`);
                const job = await res.json();

                if (job.state === 'completed') {
                    clearInterval(interval);
                    showStatus("LAUNCH CONFIRMED", 'success');
                    const mintAddr = job.result.mint;
                    const txSig = job.result.signature;
                    
                    // UPDATE SUCCESS MODAL LINKS
                    ui.successModal.querySelector('#modal-mint-addr').textContent = mintAddr;
                    ui.successModal.querySelector('#modal-tx-link').href = `https://solscan.io/tx/${txSig}`;
                    ui.successModal.querySelector('#modal-pump-link').href = `${PUMPFUN_URL_BASE}${mintAddr}`;
                    
                    ui.successModal.style.display = 'block';
                    ui.deployBtn.innerText = "LAUNCH COMPLETE"; ui.deployBtn.disabled = false;
                    isDeploying = false;
                    
                    // Reset social elements
                    ui.socialLoading.style.display = 'block';
                    ui.modalTweetLink.classList.add('hidden');
                    
                    // Start social poll
                    pollSocialStatus(mintAddr);
                    
                    refreshAllData();
                } else if (job.state === 'failed') {
                    clearInterval(interval);
                    showStatus(`DEPLOYMENT FAILED: ${job.failedReason}`, 'error');
                    isDeploying = false;
                    ui.deployBtn.disabled = false; ui.deployBtn.innerText = "RETRY LAUNCH";
                } else {
                    showStatus(`STATUS: ${job.state.toUpperCase()} (Please Wait...)`, 'normal');
                }
            } catch (e) { console.error("Polling error", e); }
        }, 2000); // Check every 2s
    };
    
    // NEW: POLL SOCIAL STATUS
    const pollSocialStatus = async (mint) => {
        let attempts = 0;
        const maxAttempts = 30; // Try for 1 minute (2s * 30)
        
        const socialInterval = setInterval(async () => {
            attempts++;
            if (attempts > maxAttempts) {
                clearInterval(socialInterval);
                ui.socialLoading.innerText = "Social Post Delayed (Check X Later)";
                ui.socialLoading.classList.remove('animate-pulse');
                ui.socialLoading.classList.add('text-gray-500');
                return;
            }

            try {
                const res = await fetch(`${BACKEND_URL}/api/token/${mint}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.tweetUrl) {
                        clearInterval(socialInterval);
                        ui.socialLoading.style.display = 'none';
                        ui.modalTweetLink.href = data.tweetUrl;
                        ui.modalTweetLink.classList.remove('hidden');
                    }
                }
            } catch (e) { /* silent fail */ }
        }, 2000);
    };
    
    // Updated Auto-Connect Logic
    window.addEventListener('load', () => {
        const savedType = localStorage.getItem('connectedWalletType');
        if (savedType) {
            // Give extensions a moment to inject
            setTimeout(() => {
                selectWallet(savedType).catch(e => {
                    console.warn("Auto-connect failed:", e);
                    localStorage.removeItem('connectedWalletType');
                });
            }, 500);
        }
    });
</script>

</body>
</html>
