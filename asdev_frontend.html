<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump.fun V2 Token Launcher (Backend IPFS Hosting)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@1.91.7/lib/index.iife.min.js"></script>
    
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .input-field {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #22c55e;
            outline: none;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }
        .spinner { border-top-color: #fff; border-left-color: #fff; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Connection, PublicKey, Transaction, SystemProgram, LAMPORTS_PER_SOL } = solanaWeb3;

        // --- CONFIGURATION ---
        const DEV_WALLET_ADDRESS = "FNLWHjvjptwC7LxycdK3Knqcv5ptC19C9rynn6u2S1tB"; 
        const FEE_AMOUNT_SOL = 0.05; 
        
        // --- RENDER BACKEND URL ---
        const BACKEND_URL = "https://asdev-1kvy.onrender.com"; 

        const App = () => {
            const [walletAddress, setWalletAddress] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [status, setStatus] = useState({ type: '', message: '' });
            const [imageFile, setImageFile] = useState(null);
            const [imagePreviewUrl, setImagePreviewUrl] = useState('');
            
            // Form State
            const [formData, setFormData] = useState({
                name: '',
                ticker: '',
                description: '',
                twitter: '',
                website: '',
                telegram: '',
                isMayhemMode: false,
                acceptedTOS: false,
            });

            // Wallet Detection/Connection
            useEffect(() => {
                if (window.solana && window.solana.isPhantom) {
                    window.solana.connect({ onlyIfTrusted: true }).then(resp => {
                        setWalletAddress(resp.publicKey.toString());
                    }).catch(() => {/* Not connected */});
                }
            }, []);

            const connectWallet = async () => {
                if (window.solana) {
                    try {
                        const resp = await window.solana.connect();
                        setWalletAddress(resp.publicKey.toString());
                        setStatus({ type: 'success', message: 'Wallet connected successfully!' });
                    } catch (err) {
                        setStatus({ type: 'error', message: 'User rejected connection.' });
                    }
                } else {
                    window.open("https://phantom.app/", "_blank");
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 1024 * 1024) {
                        setStatus({ type: 'error', message: 'Image file size must be less than 1MB.' });
                        setImageFile(null);
                        setImagePreviewUrl('');
                        e.target.value = null; 
                        return;
                    }
                    setImageFile(file);
                    setImagePreviewUrl(URL.createObjectURL(file));
                } else {
                    setImageFile(null);
                    setImagePreviewUrl('');
                }
            };
            
            const handleInputChange = (e) => {
                const { name, value, type, checked } = e.target;
                setFormData(prev => ({ 
                    ...prev, 
                    [name]: type === 'checkbox' ? checked : value 
                }));
            };

            // --- STEP 1: Send Fee Payment (Client-side) ---
            const sendFeePayment = async () => {
                const connection = new Connection("https://api.mainnet-beta.solana.com", 'confirmed');
                
                const devWalletPubkey = new PublicKey(DEV_WALLET_ADDRESS);
                const userPubkey = new PublicKey(walletAddress);
                const feeAmount = FEE_AMOUNT_SOL * LAMPORTS_PER_SOL;

                const transaction = new Transaction().add(
                    SystemProgram.transfer({
                        fromPubkey: userPubkey,
                        toPubkey: devWalletPubkey,
                        lamports: feeAmount,
                    })
                );

                const { blockhash } = await connection.getLatestBlockhash();
                transaction.recentBlockhash = blockhash;
                transaction.feePayer = userPubkey;

                setStatus({ type: 'info', message: `1/2: Approving ${FEE_AMOUNT_SOL} SOL fee in Phantom...` });
                const { signature } = await window.solana.signAndSendTransaction(transaction);

                await connection.confirmTransaction(signature, 'confirmed');

                return signature;
            };
            
            // --- STEP 2: Send All Data (Including Image) to Backend ---
            const deployToBackend = async (signature) => {
                 setStatus({ type: 'info', message: '2/2: Payment confirmed. Uploading image and deploying token via Render...' });

                const data = new FormData();
                // Append user data fields
                Object.keys(formData).forEach(key => {
                    if (key !== 'acceptedTOS') {
                        data.append(key, formData[key]);
                    }
                });
                
                // Append the required blockchain verification data
                data.append('paymentSignature', signature);
                data.append('userWallet', walletAddress);
                // Append the image file
                data.append('imageFile', imageFile); 
                
                const response = await fetch(BACKEND_URL + '/deploy', {
                    method: 'POST',
                    body: data
                });
                
                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || "Backend deployment failed.");
                }
                
                return result;
            };
            

            const handleSubmit = async (e) => {
                e.preventDefault();
                setStatus({ type: '', message: '' });

                if (!walletAddress) {
                    setStatus({ type: 'error', message: 'Please connect your Phantom wallet.' });
                    return;
                }
                if (!imageFile) {
                    setStatus({ type: 'error', message: 'Please select a token image.' });
                    return;
                }
                if (!formData.acceptedTOS) {
                    setStatus({ type: 'error', message: 'You must accept the Content Responsibility Policy before deploying.' });
                    return;
                }

                setIsLoading(true);
                
                try {
                    // 1. Send Fee Payment (Client-side)
                    const paymentSignature = await sendFeePayment();

                    // 2. Send all data (including file) to the Node.js backend
                    const deploymentResult = await deployToBackend(paymentSignature);
                    
                    setStatus({ 
                        type: 'success', 
                        message: (
                            <span className="break-all">
                                âœ… Token Deployed! Mint: {deploymentResult.mintAddress.slice(0, 10)}... <br/> 
                                ðŸ“‰ Trade Executed: Buy Tx: {deploymentResult.buyTransactionSignature.slice(0, 10)}... | Sell Tx: {deploymentResult.sellTransactionSignature.slice(0, 10)}... <br/>
                                Link: <a href={deploymentResult.pumpUrl} target="_blank" className="underline text-green-300">View on Pump.fun</a>
                            </span>
                        ) 
                    });

                } catch (err) {
                    console.error(err);
                    setStatus({ type: 'error', message: `Deployment failed: ${err.message}` });
                } finally {
                    setIsLoading(false);
                }
            };
            
            const renderStatusIcon = (type) => {
                const size = "w-5 h-5";
                switch (type) {
                    case 'error': return <svg className={`${size} text-red-400`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                    case 'success': return <svg className={`${size} text-green-400`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                    case 'info': return <svg className={`${size} text-blue-400`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>;
                    default: return null;
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    
                    {/* Header */}
                    <div className="mb-8 text-center">
                        <h1 className="text-4xl font-extrabold text-green-400 mb-2 drop-shadow-lg tracking-tight">
                            $PUMP V2 Deployment
                        </h1>
                        <p className="text-slate-400 text-lg">Secure Deployment with Backend Image Handling</p>
                    </div>

                    {/* Main Card */}
                    <div className="glass-panel w-full max-w-2xl rounded-xl shadow-2xl p-8 relative overflow-hidden">
                        
                        {/* Wallet Status */}
                        <div className="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
                            <div className="flex items-center gap-3">
                                <span className={`w-3 h-3 rounded-full ${walletAddress ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></span>
                                <span className="text-sm font-mono text-slate-300">
                                    Payer: {walletAddress 
                                        ? `${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`
                                        : 'Wallet Required'
                                    }
                                </span>
                            </div>
                            {!walletAddress ? (
                                <button 
                                    onClick={connectWallet}
                                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors shadow-lg shadow-indigo-900/50"
                                >
                                    Connect Phantom
                                </button>
                            ) : (
                                <span className="text-sm text-green-400">Connected</span>
                            )}
                        </div>

                        {/* Form */}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid md:grid-cols-3 gap-6">
                                {/* Image Upload */}
                                <div className="md:col-span-1">
                                    <label className="block text-sm font-bold text-slate-400 mb-2 uppercase tracking-wider">Token Image (Max 1MB)</label>
                                    <div className="flex flex-col items-center justify-center space-y-3">
                                        <div className="w-24 h-24 bg-slate-800 rounded-lg border-2 border-dashed border-slate-600 flex items-center justify-center overflow-hidden">
                                            {imagePreviewUrl ? (
                                                <img src={imagePreviewUrl} alt="Token Preview" className="w-full h-full object-cover" />
                                            ) : (
                                                <svg className="w-8 h-8 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-2-4h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            )}
                                        </div>
                                        <label htmlFor="file-upload" className="cursor-pointer bg-slate-700 hover:bg-slate-600 text-white text-xs font-semibold py-1.5 px-3 rounded-lg transition-colors">
                                            Select File
                                            <input 
                                                id="file-upload"
                                                type="file" 
                                                accept="image/*"
                                                onChange={handleFileChange}
                                                className="hidden"
                                                required
                                            />
                                        </label>
                                    </div>
                                </div>
                                
                                {/* Token Details */}
                                <div className="md:col-span-2 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Name</label>
                                            <input type="text" name="name" placeholder="Super Doge" value={formData.name} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field" required />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Ticker (Symbol)</label>
                                            <input type="text" name="ticker" placeholder="SDOGE" value={formData.ticker} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field" maxLength="10" required />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Description</label>
                                        <textarea name="description" placeholder="The next big meme coin on Solana." value={formData.description} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field h-20 resize-none" required></textarea>
                                    </div>
                                    
                                    {/* Static Initial Buy Strategy */}
                                    <div className="bg-slate-800 p-3 rounded-lg border border-green-700/50">
                                        <p className="text-sm font-bold text-green-400 mb-1">
                                            Initial Trading Strategy:
                                        </p>
                                        <p className="text-xs text-slate-300">
                                            Dev Wallet will execute a **0.01 SOL Buy** immediately after launch, wait **1 second**, and then execute a **100% Sell**.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Social Links */}
                            <div className="grid md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Twitter URL (Optional)</label>
                                    <input type="url" name="twitter" placeholder="https://x.com/..." value={formData.twitter} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Website URL (Optional)</label>
                                    <input type="url" name="website" placeholder="https://..." value={formData.website} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">Telegram Link (Optional)</label>
                                    <input type="url" name="telegram" placeholder="https://t.me/..." value={formData.telegram} onChange={handleInputChange} className="w-full p-3 rounded-lg input-field" />
                                </div>
                            </div>

                            {/* Options and Button */}
                            <div className="pt-4 space-y-4">
                                <div className="flex items-center justify-between p-3 bg-slate-800 rounded-lg">
                                    <label htmlFor="mayhem-mode" className="text-sm font-medium text-slate-300">
                                        Enable Mayhem Mode (Token-2022)
                                    </label>
                                    <input 
                                        id="mayhem-mode"
                                        type="checkbox" 
                                        name="isMayhemMode"
                                        checked={formData.isMayhemMode}
                                        onChange={handleInputChange}
                                        className="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 rounded focus:ring-green-500"
                                    />
                                </div>
                                
                                {/* Legal Disclaimer */}
                                <div className="flex items-start p-3 border border-yellow-600 bg-yellow-900/20 rounded-lg">
                                    <input 
                                        id="tos-accept"
                                        type="checkbox" 
                                        name="acceptedTOS"
                                        checked={formData.acceptedTOS}
                                        onChange={handleInputChange}
                                        className="mt-1 w-4 h-4 text-yellow-500 bg-gray-700 border-yellow-600 rounded focus:ring-yellow-500"
                                    />
                                    <label htmlFor="tos-accept" className="ml-3 text-sm text-yellow-300 leading-tight">
                                        I confirm I have read the <span className="font-bold">Content Responsibility Policy</span>, understand that I am solely liable for the image and metadata content, and confirm the content is legal and non-offensive.
                                    </label>
                                </div>

                                <button 
                                    type="submit" 
                                    disabled={isLoading || !walletAddress || !formData.acceptedTOS}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-xl transition-all transform hover:scale-[1.005] 
                                        ${(isLoading || !formData.acceptedTOS) ? 'bg-slate-600 cursor-not-allowed' : 'bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white'}`}
                                >
                                    {isLoading ? (
                                        <span className="flex items-center justify-center gap-3">
                                            <div className="spinner w-5 h-5 border-4 border-t-transparent border-white rounded-full animate-spin"></div>
                                            Processing Transaction...
                                        </span>
                                    ) : (
                                        `Deploy Token (Pay ${FEE_AMOUNT_SOL} SOL Fee)`
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Status Messages */}
                    {status.message && (
                        <div className={`mt-6 px-6 py-4 rounded-lg max-w-2xl w-full flex items-start gap-3 border ${
                            status.type === 'error' ? 'bg-red-900/30 border-red-500/50 text-red-200' : 
                            status.type === 'success' ? 'bg-green-900/30 border-green-500/50 text-green-200' :
                            'bg-blue-900/30 border-blue-500/50 text-blue-200'
                        }`}>
                            {renderStatusIcon(status.type)}
                            <span className="text-sm font-medium leading-relaxed">{status.message}</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
